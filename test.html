<!DOCTYPE html>
<html lang="en" data-h2h-version="v2">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Head to Head</title>

<style>
  /* === v2 — styles unchanged from v1 === */
  /* --- Typography: inherit from site (copied via JS into CSS vars) --- */
  #h2h{ --ff: inherit; --fvs: normal; }
  #h2h, #h2h *{ font-family: var(--ff) !important; font-variation-settings: var(--fvs, normal); }
  #h2h select, #h2h button, #h2h input{ font: inherit; line-height: inherit; }

  :root{
    --ring:#d0d7de; --head:#000; --fg:#111;
    --z1:#fff; --z2:#f7f7f7; --ok:#128a3a; --warn:#f1b300; --bad:#cc1e1e;
    --blue-verylight:#eef6ff; --blue-verylight-strong:#e4f0ff; --blue-ring:#cfe1ff; --blue-ring-strong:#a9c6ff;
    --active:#9e0000; --bar1:#9e0000; --bar2:#223b7c;
  }
  body{ color:var(--fg); background:#fff; }
  .wrap{ max-width:1100px; margin:0 auto; padding:12px 10px; }

  /* Controls */
  .controls{ display:flex; flex-wrap:wrap; gap:.75rem 1rem; align-items:flex-end; margin:.25rem 0 .6rem; }
  .fld{ display:flex; flex-direction:column; gap:6px; }
  .lbl{ font-weight:700; font-size:.9rem; }
  select{
    min-width:260px; padding:9px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; font-weight:700;
  }
  .swap{
    display:none; align-self:flex-end; padding:8px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; cursor:pointer;
    font-weight:800;
  }
  .swap:hover{ border-color:#999; }

  /* Two-bar header (non-sticky) */
  .clubbars{
    margin:4px 0 10px;
    border-radius:10px; overflow:hidden;
    box-shadow: 0 1px 0 rgba(0,0,0,.06);
  }
  .clubbar{ padding:8px 12px; text-align:center; color:#fff; letter-spacing:.25px; }
  .clubbar.primary{ background:var(--bar1); text-transform:uppercase; font-weight:900; font-size: clamp(1rem, 2.6vw, 1.32rem); }
  .clubbar.opponent{ background:var(--bar2); font-weight:400; font-size: clamp(.95rem, 2.2vw, 1.18rem); }

  /* Legend + venue + related chips */
  .legendbar{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; margin:.3rem 0 .6rem; }
  .legend{ color:#666; font-size:.9rem; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .pill{ display:inline-grid; place-items:center; width:22px; height:22px; border-radius:999px; font-size:.72rem; font-weight:800; }
  .w{ background:var(--ok); color:#fff; }
  .d{ background:var(--warn); color:#000; }
  .l{ background:var(--bad); color:#fff; }

  .legend-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .relwrap{ display:none; align-items:center; gap:.4rem .5rem; }
  .relhint{ font-size:.8rem; color:#6b7280; margin-right:.25rem; }
  .rellist{ display:flex; flex-wrap:wrap; gap:.35rem; }
  .chip{ display:inline-flex; align-items:center; gap:.45rem; border:1px solid var(--blue-ring); border-radius:999px; padding:3px 7px; background:var(--blue-verylight); }
  .chip input{ accent-color:#3b82f6; }
  .chip:has(input:checked){ border-color:var(--blue-ring-strong); background:var(--blue-verylight-strong); }

  .venue{ display:none; }
  .seg{ display:inline-flex; overflow:hidden; border:1px solid var(--ring); border-radius:999px; }
  .seg button{
    padding:6px 12px; background:#fff; font-weight:800; border-left:1px solid var(--ring); cursor:pointer;
    font-size:.88rem; line-height:1;
  }
  .seg button:first-child{ border-left:none; }
  .seg button[aria-pressed="true"]{ background:var(--active); color:#fff; border-color:var(--active); }

  .err{ display:none; background:#ffe9ec; color:#b00020; border:1px solid #f0b9c2; border-radius:10px; padding:8px 10px; font-weight:700; white-space:pre-wrap; margin:.5rem 0; }

  /* Table */
  .tblwrap{ overflow-x:auto; border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,.06); border:1px solid var(--ring); }
  table{
    width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums;
    table-layout: fixed;
  }

  col.cg-date   { width: 14ch; }
  col.cg-league { width: 30ch; }
  col.cg-home   { width: 27%; }
  col.cg-score  { width: 7ch; }
  col.cg-away   { width: 27%; }
  col.cg-result { width: 7ch; }

  @media (max-width: 820px){
    .col-league{ display:none; }
    .col-result{ display:none; }
    colgroup{ display:none !important; }
    table{ table-layout:auto; width:100%; }
  }
  @media (max-width: 760px){ col.cg-date{ width: 8ch; } }
  @media (max-width: 500px){ col.cg-date{ width: 7ch; } }

  thead th{
    background:var(--head); color:#fff; text-transform:uppercase;
    font-size:.76rem; letter-spacing:.3px; padding:7px 9px; text-align:left; white-space:nowrap;
  }
  tbody td{
    padding:6px 8px; vertical-align:middle; font-size:.88em; line-height:1.24; word-break:break-word;
  }
  tbody tr:nth-child(odd){ background:var(--z2); }
  tbody tr:nth-child(even){ background:var(--z1); }

  td.home, td.away{ vertical-align:middle; }
  td.home .cell, td.away .cell{ display:flex; align-items:center; height:100%; min-height: 1.2em; }
  td.home .cell{ justify-content:flex-end; text-align:right; }
  td.away .cell{ justify-content:flex-start; text-align:left; }

  td.score{ text-align:center; font-weight:900; }
  td.result{ text-align:center; padding-left:6px; padding-right:6px; }

  .tiny{ font-size:10px; color:#666; line-height:1.1; }
  .tiny .badge{ display:none; margin-top:2px; }
  .badge{ display:inline-grid; place-items:center; width:18px; height:18px; border-radius:999px; font-size:.78rem; font-weight:900; }
  .badge.w{ background:var(--ok); color:#fff; }
  .badge.d{ background:var(--warn); color:#000; }
  .badge.l{ background:var(--bad); color:#fff; }

  th.col-score, td.score{ padding-left:6px; padding-right:6px; }
  td.score > div{ white-space:nowrap; }
  td.score .tiny{ white-space:nowrap; }

  tr.reladd, tr.reladd td{ background:var(--blue-verylight) !important; }

  .date-full, .date-short, .date-slim{ white-space:nowrap; }
  .date-short, .date-slim{ display:none; }

  @media (max-width: 820px){
    .col-league{ display:none; }
    .col-result{ display:none; }
    .tiny .badge{ display:inline-grid; }
  }
  @media (max-width: 760px){ .date-full{ display:none; } .date-short{ display:inline; } }
  @media (max-width: 500px){ .date-short{ display:none; } .date-slim{ display:inline; } }

  .team-clip{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  @media (max-width: 560px){ .team-clip{ -webkit-line-clamp:3; } }

  @keyframes rowFadeIn { from { opacity:0; } to { opacity:1; } }
  @keyframes rowFadeOut{ from { opacity:1; } to { opacity:0; } }
  tbody tr.anim-in{ opacity:0; animation: rowFadeIn 220ms ease-out forwards; animation-delay: calc(var(--i,0) * 24ms); }
  tbody tr.anim-out{ animation: rowFadeOut 180ms ease-in forwards; }
  @media (prefers-reduced-motion: reduce){
    tbody tr.anim-in, tbody tr.anim-out{ animation:none; opacity:1; }
  }
</style>
</head>
<body>
<div id="h2h" class="wrap">

  <div class="controls">
    <div class="fld">
      <label class="lbl" for="club">Club</label>
      <select id="club">
        <option disabled selected>Loading…</option>
      </select>
    </div>
    <div class="fld">
      <label class="lbl" for="opponent">Opponent</label>
      <select id="opponent" disabled>
        <option disabled selected>Select a club first…</option>
      </select>
    </div>
    <button id="swap" class="swap" type="button" title="Swap clubs" aria-label="Swap clubs">⇄</button>
  </div>

  <div class="clubbars" aria-live="polite">
    <div id="bar1" class="clubbar primary">HEAD TO HEAD</div>
    <div id="bar2" class="clubbar opponent">Select two clubs</div>
  </div>

  <div id="error" class="err"></div>

  <div class="legendbar">
    <div class="legend">
      <span><span class="pill w">W</span> Win</span>
      <span><span class="pill d">D</span> Draw</span>
      <span><span class="pill l">L</span> Loss</span>
    </div>

    <div class="legend-right">
      <!-- Related clubs (primary only) -->
      <div id="relwrap" class="relwrap">
        <span class="relhint">Include related clubs</span>
        <div id="rellist" class="rellist"></div>
      </div>

      <!-- Venue pills -->
      <div id="venue" class="venue">
        <div class="seg" role="group" aria-label="Venue">
          <button type="button" data-val="all"  aria-pressed="true">All</button>
          <button type="button" data-val="home" aria-pressed="false">Home</button>
          <button type="button" data-val="away" aria-pressed="false">Away</button>
          <button type="button" data-val="neutral" aria-pressed="false">Neutral</button>
        </div>
      </div>
    </div>
  </div>

  <div class="tblwrap">
    <table>
      <colgroup>
        <col class="cg-date">
        <col class="cg-league">
        <col class="cg-home">
        <col class="cg-score">
        <col class="cg-away">
        <col class="cg-result">
      </colgroup>

      <thead>
        <tr>
          <th>Date</th>
          <th class="col-league">League</th>
          <th style="text-align:right">Home</th>
          <th class="col-score" style="text-align:center">Score</th>
          <th>Away</th>
          <th class="col-result" style="text-align:center">Result</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="6" style="color:#666; font-size:.92rem;">Pick a Club and Opponent.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/*!
 * H2H v2.0 — logic overhaul (entities + clubs-meta), UI unchanged.
 * - Dropdowns by entity (home_entity / away_entity)
 * - Rows show team names (home / away)
 * - Related chips via clubs-meta (phoenix + merger rules)
 * - Play-off round under league name (tiny, grey, all caps)
 * You can override sources:
 *   window.H2H_JSON_URL        (results.json)
 *   window.H2H_CLUBS_META_URL  (clubs-meta.json)
 */
(function(){
  var JSON_SRC = window.H2H_JSON_URL       || "https://raw.githubusercontent.com/rckd-nl/website/main/results.json";
  var META_SRC = window.H2H_CLUBS_META_URL || "https://raw.githubusercontent.com/rckd-nl/website/main/clubs-meta.json";

  // ---- Typography (unchanged) ----
  function applySiteTypography(){
    var root = document.getElementById('h2h');
    if(!root) return;
    var cs = getComputedStyle(document.body || document.documentElement);
    root.style.setProperty('--ff', cs.fontFamily || 'inherit');
    root.style.setProperty('--fvs', cs.fontVariationSettings || 'normal');
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', applySiteTypography, { once:true });
  } else { applySiteTypography(); }
  if (document.fonts && document.fonts.ready){
    document.fonts.ready.then(applySiteTypography).catch(function(){});
  }

  // ---- DOM ----
  function $(s){ return document.querySelector(s); }
  var CLUB  = $('#club');
  var OPP   = $('#opponent');
  var TB    = $('#rows');
  var ERR   = $('#error');
  var VENUEBOX = $('#venue');
  var RELWRAP = $('#relwrap');
  var RELLIST = $('#rellist');
  var BAR1 = $('#bar1');
  var BAR2 = $('#bar2');
  var SWAP = $('#swap');

  // ---- State ----
  var allMatches = [];
  var allEntities = [];        // unique list of entities for dropdowns
  var relatedOffers = {};      // entity -> array of related entity names to OFFER as chips
  var venueFilter = 'all';
  var includedRelated = new Set(); // selected related entities for primary club
  var currentRowKeys = new Set();
  var hasRendered = false;

  // ---- Utils ----
  function showErr(m,d){ ERR.style.display='block'; ERR.textContent = d ? (m+"\n\n"+d) : m; }
  function clearErr(){ ERR.style.display='none'; ERR.textContent=''; }
  function startYear(s){ var m=/^(\d{4})/.exec(String(s)||''); return m?+m[1]:0; }
  function dateKey(m){ return m.date ? Date.parse(m.date+"T00:00:00Z") : null; }
  function seasonKey(m){ return startYear(m.season||0); }
  function fmtDateFull(d){ if(!d) return '—'; var dt=new Date(d+"T12:00:00Z"); return dt.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric', timeZone:'Europe/London'}); }
  function fmtDateShort(d){ if(!d) return '—'; var dt=new Date(d+"T12:00:00Z"); var dd=String(dt.getUTCDate()).padStart(2,'0'); var mm=String(dt.getUTCMonth()+1).padStart(2,'0'); var yy=String(dt.getUTCFullYear()).slice(-2); return dd+'/'+mm+'/'+yy; }
  function fmtDateSlim(d){ if(!d) return '—'; var dt=new Date(d+"T12:00:00Z"); var d1=dt.getUTCDate(); var m1=dt.getUTCMonth()+1; var yy=String(dt.getUTCFullYear()).slice(-2); return d1+'/'+m1+'/'+yy; }
  function hasBoth(a,b){ return (a!=null && b!=null && a!=='' && b!==''); }
  function isNeutral(m){ return !!m.neutral || (m.venue && String(m.venue).toLowerCase()==='neutral'); }
  function stripSeasonFromTitle(t){ return String(t||'').replace(/\s+\d{4}[\u2013-]\d{2}.*$/,''); }
  function esc(s){ return String(s==null?'':s).replace(/[&<>"']/g,function(c){return ({'&':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c];}); }
  function keyFor(m){
    return [
      m.date || m.season, m.home, m.away,
      m.home_goals, m.away_goals, m.score||'',
      m.home_entity||'', m.away_entity||'',
      m.playoffs?'P':'', m.playoff_round||'',
      m.neutral?'N':'', m.cross_division?'X':'',
      m.result||''
    ].join('|');
  }
  function updateSwapVisibility(){ SWAP.style.display = (CLUB.value && OPP.value) ? 'inline-block' : 'none'; }

  // Venue segmented control
  function setVenue(val){
    venueFilter=val;
    var btns = VENUEBOX.querySelectorAll('button[data-val]');
    for(var i=0;i<btns.length;i++){
      var b=btns[i], on=b.getAttribute('data-val')===val;
      b.setAttribute('aria-pressed', on?'true':'false');
      if(on){ b.style.background = 'var(--active)'; b.style.borderColor='var(--active)'; b.style.color = '#fff'; }
      else{   b.style.background = '#fff'; b.style.borderColor='var(--ring)'; b.style.color = '#111'; }
    }
  }
  VENUEBOX.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('button[data-val]');
    if(!btn) return;
    setVenue(btn.getAttribute('data-val'));
    render();
  });

  // Related chips change → re-render (only primary club side)
  RELLIST.addEventListener('change', function(e){
    var t = e.target;
    if (!t || t.tagName !== 'INPUT') return;
    if (t.checked) includedRelated.add(t.value); else includedRelated.delete(t.value);
    updateVenueButtons(CLUB.value, OPP.value);
    render();
  });

  function validOpponentsForEntity(entityName){
    var opps=new Set();
    for(var i=0;i<allMatches.length;i++){
      var m=allMatches[i];
      if(m.home_entity===entityName) opps.add(m.away_entity);
      if(m.away_entity===entityName) opps.add(m.home_entity);
    }
    return Array.from(opps).sort(function(a,b){ return a.localeCompare(b,'en'); });
  }

  function buildRelatedOffersMap(meta){
    var offers = {}; // entity -> array of related entities to show as toggles

    function addOffer(from, to){
      if(!from || !to || from===to) return;
      (offers[from] = offers[from] || []);
      if(offers[from].indexOf(to)===-1) offers[from].push(to);
    }

    // Phoenix: new ↔ old (both directions)
    var phoenix = (meta.relationships && meta.relationships.phoenix) || [];
    phoenix.forEach(function(p){
      var n = p.new, o = p.old;
      addOffer(n, o); // new can include old
      addOffer(o, n); // old can include new
    });

    // Merger rules:
    // - new can include each parent
    // - each parent can include the new (but not each other)
    var mergers = (meta.relationships && meta.relationships.merger) || [];
    mergers.forEach(function(mg){
      var n = mg.new, parents = mg.parents || [];
      parents.forEach(function(p){
        addOffer(n, p); // new -> parent
        addOffer(p, n); // parent -> new
      });
    });

    // sort values for stable UI
    Object.keys(offers).forEach(function(k){
      offers[k] = offers[k].slice().sort(function(a,b){ return a.localeCompare(b,'en'); });
    });

    return offers;
  }

  function buildRelatedUI(primaryEntity){
    includedRelated.clear();
    var list = relatedOffers[primaryEntity] || [];
    if(!list.length){ RELWRAP.style.display='none'; RELLIST.innerHTML=''; return; }
    var bits=[];
    list.forEach(function(n,i){
      var id='relc-'+i+'-'+Math.random().toString(36).slice(2,8);
      bits.push('<label class="chip"><input id="'+id+'" type="checkbox" value="'+esc(n)+'" /> <span>'+esc(n)+'</span></label>');
    });
    RELLIST.innerHTML = bits.join('');
    RELWRAP.style.display='inline-flex';
  }

  function updateVenueButtons(primaryEntity, opponentEntity){
    var clubSet=new Set([primaryEntity].concat(Array.from(includedRelated)));
    var oppSet =new Set([opponentEntity]);
    var subset = allMatches.filter(function(m){
      return (clubSet.has(m.home_entity) && oppSet.has(m.away_entity)) || (clubSet.has(m.away_entity) && oppSet.has(m.home_entity));
    });

    var hasN = subset.some(function(m){ return isNeutral(m); });
    var hasH = subset.some(function(m){ return !isNeutral(m) && clubSet.has(m.home_entity); });
    var hasA = subset.some(function(m){ return !isNeutral(m) && clubSet.has(m.away_entity); });

    var btnH   = VENUEBOX.querySelector('button[data-val="home"]');
    var btnA   = VENUEBOX.querySelector('button[data-val="away"]');
    var btnN   = VENUEBOX.querySelector('button[data-val="neutral"]');
    btnH.style.display = hasH ? 'inline-block' : 'none';
    btnA.style.display = hasA ? 'inline-block' : 'none';
    btnN.style.display = hasN ? 'inline-block' : 'none';

    if ((venueFilter==='home' && !hasH) || (venueFilter==='away' && !hasA) || (venueFilter==='neutral' && !hasN)){
      setVenue('all');
    }
  }

  function normResultVal(val){
    if(!val) return '';
    var v=String(val).trim().toUpperCase();
    if (v==='HOME') v='H';
    if (v==='AWAY') v='A';
    if (v==='DRAW') v='D';
    if (v==='WIN' || v==='LOSS' || v==='W' || v==='L') return v;
    if (v==='H' || v==='A' || v==='D') return v;
    return '';
  }

  function resultFromJSON(m, clubSet){
    var r = normResultVal(m.result);
    if (r==='W' || r==='L' || r==='D') return r;

    if (r==='D') return 'D';
    if (r==='H'){ return clubSet.has(m.home_entity) ? 'W' : 'L'; }
    if (r==='A'){ return clubSet.has(m.away_entity) ? 'W' : 'L'; }

    // Fallback to scoreline
    if (m.home_goals === m.away_goals) return 'D';
    var homeWin = m.home_goals > m.away_goals;
    var isHome  = clubSet.has(m.home_entity);
    return (homeWin && isHome) || (!homeWin && !isHome) ? 'W' : 'L';
  }

  function onClubChange(){
    includedRelated.clear();
    RELWRAP.style.display='none'; RELLIST.innerHTML='';
    var ent=CLUB.value;

    BAR1.textContent = ent ? ent.toUpperCase() : 'HEAD TO HEAD';
    BAR2.textContent = 'Select two clubs';

    var previousOpp=OPP.value||'';
    var opps=validOpponentsForEntity(ent);
    OPP.disabled = opps.length===0;
    var html = '<option value="" '+(previousOpp && opps.indexOf(previousOpp)>-1?'':'selected')+' disabled>'+(opps.length?'Select opponent…':'No opponents found')+'</option>';
    for(var i=0;i<opps.length;i++){
      var o=opps[i]; html += '<option '+(o===previousOpp?'selected':'')+'>'+esc(o)+'</option>';
    }
    OPP.innerHTML = html;

    if(previousOpp && opps.indexOf(previousOpp)>-1){
      buildRelatedUI(ent);
      updateVenueButtons(ent, previousOpp);
      VENUEBOX.style.display='block';
      render();
    }else{
      VENUEBOX.style.display='none';
      TB.innerHTML = '<tr><td colspan="6" style="color:#666; font-size:.92rem;">Pick an Opponent.</td></tr>';
      hasRendered=false; currentRowKeys.clear();
    }
    updateSwapVisibility();
  }

  function onOppChange(){
    includedRelated.clear();
    RELWRAP.style.display='none'; RELLIST.innerHTML='';
    if (CLUB.value && OPP.value){
      BAR1.textContent = CLUB.value.toUpperCase();
      BAR2.textContent = 'vs ' + OPP.value;

      buildRelatedUI(CLUB.value);
      updateVenueButtons(CLUB.value, OPP.value);
      VENUEBOX.style.display='block';
      render();
    } else {
      BAR1.textContent = CLUB.value ? CLUB.value.toUpperCase() : 'HEAD TO HEAD';
      BAR2.textContent = 'Select two clubs';
      VENUEBOX.style.display='none';
    }
    updateSwapVisibility();
  }

  // Swap button
  SWAP.addEventListener('click', function(){
    if(!(CLUB.value && OPP.value)) return;

    var oldVenue = venueFilter;
    var oldClub = CLUB.value, oldOpp = OPP.value;

    CLUB.value = oldOpp;
    onClubChange();

    var opts = Array.from(OPP.options).map(function(o){return o.value||o.textContent;});
    if (opts.indexOf(oldClub)>-1){
      OPP.value = oldClub;
      onOppChange();
    } else {
      OPP.value = '';
      onOppChange();
    }

    if (oldVenue === 'home') { setVenue('away'); render(); }
    else if (oldVenue === 'away') { setVenue('home'); render(); }
  });

  function render(){
    var ent=CLUB.value, opp=OPP.value;
    if(!ent || !opp){
      TB.innerHTML = '<tr><td colspan="6" style="color:#666; font-size:.92rem;">Pick a Club and Opponent.</td></tr>';
      hasRendered=false; currentRowKeys.clear();
      return;
    }

    var clubSet=new Set([ent].concat(Array.from(includedRelated)));
    var oppSet =new Set([opp]);

    var mm = allMatches.filter(function(m){
      return (clubSet.has(m.home_entity) && oppSet.has(m.away_entity)) || (clubSet.has(m.away_entity) && oppSet.has(m.home_entity));
    });

    if (venueFilter==='home')        mm = mm.filter(function(m){ return !isNeutral(m) && clubSet.has(m.home_entity); });
    else if(venueFilter==='away')    mm = mm.filter(function(m){ return !isNeutral(m) && clubSet.has(m.away_entity); });
    else if(venueFilter==='neutral') mm = mm.filter(function(m){ return isNeutral(m); });

    mm.sort(function(a,b){
      var kb = (dateKey(b)!=null?dateKey(b):seasonKey(b));
      var ka = (dateKey(a)!=null?dateKey(a):seasonKey(a));
      return kb - ka; // newest first
    });

    var newKeys = new Set(mm.map(keyFor));

    if (hasRendered){
      var toRemove = [];
      currentRowKeys.forEach(function(k){ if (!newKeys.has(k)) toRemove.push(k); });
      if (toRemove.length){
        var rows = TB.querySelectorAll('tr[data-key]');
        rows.forEach(function(r){
          var k = r.getAttribute('data-key');
          if (toRemove.indexOf(k)>-1){
            r.classList.remove('anim-in');
            r.classList.add('anim-out');
          }
        });
        setTimeout(commitRender, 190);
        return;
      }
    }

    commitRender();

    function playoffTinyLine(m){
      if(!m.playoffs) return '';
      var round = (m.playoff_round || '').trim();
      var label = 'PLAY-OFF' + (round ? ' ' + round.toUpperCase() : '');
      return '<div class="tiny" style="margin-top:2px; letter-spacing:.2px;">'+esc(label)+'</div>';
    }

    function commitRender(){
      if(!mm.length){
        TB.innerHTML = '<tr><td colspan="6" style="color:#666; font-size:.92rem;">No matches found for this pairing.</td></tr>';
        hasRendered=true; currentRowKeys = new Set();
        return;
      }

      var rows = [];
      for(var i=0;i<mm.length;i++){
        var m=mm[i];
        var dateFull  = fmtDateFull(m.date);
        var dateShort = fmtDateShort(m.date);
        var dateSlim  = fmtDateSlim(m.date);
        var seasonText = (m.season||'') + (m.cross_division ? ' Play-offs' : '');
        var scoreTxt = m.score ? String(m.score) : (String(m.home_goals)+'\u2013'+String(m.away_goals));
        var res = resultFromJSON(m, clubSet);
        var resBadge = '<span class="pill '+(res==='W'?'w':res==='D'?'d':'l')+'">'+res+'</span>';
        var tinyBadge = '<div class="tiny"><span class="badge '+(res==='W'?'w':res==='D'?'d':'l')+'">'+res+'</span></div>';

        var viaRelated = includedRelated.has(m.home_entity) || includedRelated.has(m.away_entity);
        var rowKey = keyFor(m);

        rows.push(
          '<tr class="'+(viaRelated?'reladd ':'')+'anim-in" style="--i:'+i+'" data-key="'+esc(rowKey)+'">'+
            '<td>'+
              '<span class="date-full">'+dateFull+'</span>'+
              '<span class="date-short">'+dateShort+'</span>'+
              '<span class="date-slim">'+dateSlim+'</span>'+
              '<div class="tiny">'+esc(seasonText)+'</div>'+
            '</td>'+
            '<td class="col-league">'+
              esc(stripSeasonFromTitle(m.leagueName || m.league || ''))+
              playoffTinyLine(m)+
            '</td>'+
            '<td class="home"><div class="cell"><span class="team-clip">'+esc(m.home)+'</span></div></td>'+
            '<td class="score">'+
              '<div>'+esc(scoreTxt)+'</div>'+tinyBadge+
            '</td>'+
            '<td class="away"><div class="cell"><span class="team-clip">'+esc(m.away)+'</span></div></td>'+
            '<td class="result col-result">'+resBadge+'</td>'+
          '</tr>'
        );
      }
      TB.innerHTML = rows.join('');
      hasRendered=true;
      currentRowKeys = new Set(Array.from(newKeys));
    }
  }

  // ---- Boot (v2) ----
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  async function init(){
    try{
      var controller = new AbortController();
      var t = setTimeout(function(){ controller.abort(); }, 12000);

      // Fetch results (same shape as v1: seasons -> divisions -> matches), but matches include *_entity fields
      var res = await fetch(JSON_SRC + (JSON_SRC.indexOf('?')>-1?'&':'?') + 'v=' + Date.now(), { cache:'no-store', credentials:'omit', signal: controller.signal });
      clearTimeout(t);
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      var raw = await res.json();

      // Fetch clubs-meta (relationships); non-blocking failure tolerated
      var meta = null;
      try{
        var mres = await fetch(META_SRC + (META_SRC.indexOf('?')>-1?'&':'?') + 'v=' + Date.now(), { cache:'no-store', credentials:'omit' });
        if(mres.ok){ meta = await mres.json(); }
      }catch(_){ /* ignore */ }

      // Flatten matches and compute leagueName (title without season)
      var seasons = Array.isArray(raw.seasons) ? raw.seasons : [];
      if(!seasons.length) throw new Error('No "seasons" array in results.json');

      for(var s=0; s<seasons.length; s++){
        var season = seasons[s];
        var divs = season.divisions || {};
        for (var key in divs){
          var div = divs[key] || {};
          var leagueName = stripSeasonFromTitle(div.title || '');
          var matches = div.matches || [];
          for(var j=0;j<matches.length;j++){
            var m = matches[j];
            // Ensure entity fields exist (fall back to team names if not provided)
            var he = m.home_entity || m.home || '';
            var ae = m.away_entity || m.away || '';
            var entry = Object.assign({}, m, {
              season: season.season,
              leagueName: leagueName,
              home_entity: he,
              away_entity: ae
            });
            allMatches.push(entry);
          }
        }
      }
      if(!allMatches.length) throw new Error('No matches found in results.json');

      // Build entity list for dropdowns
      var entSet = new Set();
      allMatches.forEach(function(m){ if(m.home_entity) entSet.add(m.home_entity); if(m.away_entity) entSet.add(m.away_entity); });
      allEntities = Array.from(entSet).sort(function(a,b){ return a.localeCompare(b,'en'); });

      // Clubs-meta related offers
      relatedOffers = meta ? buildRelatedOffersMap(meta) : {};

      // Populate primary club selector with entities
      var opts = ['<option value="" selected disabled>Select club…</option>'];
      for(var i=0;i<allEntities.length;i++) opts.push('<option>'+esc(allEntities[i])+'</option>');
      CLUB.innerHTML = opts.join('');

      CLUB.addEventListener('change', onClubChange, { passive:true });
      OPP.addEventListener('change', onOppChange, { passive:true });

      VENUEBOX.style.display='none';
      SWAP.style.display='none';
      clearErr();
    }catch(err){
      showErr('Could not load/parse results.json.', (err && err.message) ? err.message : String(err));
      var fail = '<tr><td colspan="6" style="color:#666; font-size:.92rem;">Failed to load data.</td></tr>';
      try{ TB.innerHTML = fail; }catch(_){}
      console.error(err);
    }
  }
})();
</script>
</body>
</html>
