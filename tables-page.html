<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>National League Archive — Standings</title>

<style>
  /* Design tokens */
  :root{
    --bg-odd:#f6f6f6; --bg-even:#ffffff;
    --head-bg:#000000; --head-fg:#ffffff; /* header row */
    --cap-bg:#9e0000;  --cap-fg:#ffffff;  /* caption strip */
    --gold:gold; --green:#e7f7e9; --blue:#e8f0ff; --pink:#ffe0e6; --grey:#e6e6e6;
    --gd-pos:#0a7d2a; --gd-zero:#555; --gd-neg:#b00020;
    --ring:#d0d7de; --ring-dark:#30363d;
    --text:#111;
  }

  /* Page frame */
  .wrap{ max-width:1200px; margin:0 auto; padding:12px 8px; color:var(--text); }
  .controls{ display:flex; gap:.75rem; align-items:center; margin:.5rem 0 .75rem; flex-wrap:wrap; }
  .controls label{ font-weight:600; }
  .controls select{ padding:6px 10px; border:1px solid var(--ring); border-radius:8px; background:#fff; }

  /* Table */
  .table-wrap{ max-width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:10px; box-shadow:0 1px 0 rgba(0,0,0,.05); }
  table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums; }
  caption{ background:var(--cap-bg); color:var(--cap-fg); text-align:center; font-weight:700; padding:10px; caption-side:top; font-size:1.1rem; letter-spacing:.2px; }
  thead th{ position:sticky; top:0; z-index:1; background:var(--head-bg); color:var(--head-fg); text-transform:uppercase; font-size:.8rem; letter-spacing:.4px; }
  th,td{ padding:8px 10px; border:none; vertical-align:middle; text-align:center; white-space:nowrap; }
  th:nth-child(2), td:nth-child(2){ text-align:left; white-space:normal; }
  th:nth-child(n+3), td:nth-child(n+3){ text-align:right; }

  /* Zebra (unclassed only) */
  tbody tr:not(.champion):not(.promoted):not(.playoff):not(.relegated):not(.expunged):nth-child(odd){ background:var(--bg-odd); }
  tbody tr:not(.champion):not(.promoted):not(.playoff):not(.relegated):not(.expunged):nth-child(even){ background:var(--bg-even); }
  /* Lock hover: no colour change at all */
  tbody tr:hover{ background:inherit !important; color:inherit !important; }

  /* Status rows */
  .champion{  background:var(--gold); }
  .promoted{  background:var(--green); }
  .playoff{   background:var(--blue); }
  .relegated{ background:var(--pink); }
  .expunged{  background:var(--grey); color:#666; }

  /* GD colour (never bold) */
  td.gd-pos{ color:var(--gd-pos); font-weight:400; }
  td.gd-zero{ color:var(--gd-zero); font-weight:400; }
  td.gd-neg{ color:var(--gd-neg); font-weight:400; }

  /* Only Pos, Pts (+ PPG when present) bold */
  th.strongcol, td.strongcol{ font-weight:700; }

  /* Legend (rebuilt per table) */
  .legend{ font-size:.9rem; color:#555; margin-top:.5rem; }
  .legend .swatch{ display:inline-block; width:.9em; height:.9em; border-radius:3px; margin:0 .35rem -.12rem .35rem; }
  .legend .gold{ background:var(--gold); } .legend .green{ background:var(--green); } .legend .blue{ background:var(--blue); }
  .legend .pink{ background:var(--pink); } .legend .grey{ background:#bbb; }

  /* Division pills */
  .pillbar{ display:none; gap:.4rem; flex-wrap:wrap; margin:.25rem 0 .2rem; }
  .pillbar button{ border:1px solid var(--ring); background:#fff; color:inherit; border-radius:999px; padding:6px 10px; cursor:pointer; }
  /* Active pill colour: pre-2004 black, 2004+ #9e0000 */
  .pillbar[data-era="pre"]    button[aria-pressed="true"]{ background:#111;    color:#fff; border-color:#111; }
  .pillbar[data-era="modern"] button[aria-pressed="true"]{ background:#9e0000; color:#fff; border-color:#9e0000; }

  /* Error panel */
  .error{ display:none; background:#ffe9ec; color:#b00020; border:1px solid #f0b9c2; padding:8px 10px; border-radius:8px; margin:.5rem 0; font-weight:600; white-space:pre-wrap; }

  /* Dark mode */
  @media (prefers-color-scheme: dark){
    :root{ --bg-odd:#000; --bg-even:#000; --text:#eee; }
    html, body, table, caption, th, td { color:#eee; }
    .controls select{ background:transparent; color:inherit; border-color:var(--ring-dark); }
    .legend{ color:#ccc; }
    /* Unclassed rows should be pure black in dark mode */
    tbody tr:not(.champion):not(.promoted):not(.playoff):not(.relegated):not(.expunged){
      background:#000 !important; color:#fff !important;
    }
    .relegated{ background:#44222a; }
    .promoted{  background:#1c2a1e; }
    .playoff{   background:#1a2234; }
    .expunged{  background:#2a2a2a; color:#bbb; }
    .pillbar button{ background:transparent; color:inherit; border-color:var(--ring-dark); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="controls">
    <label for="season-select">Season:</label>
    <select id="season-select" aria-label="Select season"></select>
  </div>

  <div id="error" class="error" role="alert"></div>

  <div id="division-pills" class="pillbar" aria-label="Divisions"></div>

  <div class="table-wrap">
    <table id="standings" aria-describedby="legend">
      <caption id="table-caption">Alliance / Conference / National League — Standings</caption>
      <thead>
        <tr>
          <th>Pos</th><th>Team</th><th><abbr title="Played">P</abbr></th>
          <th><abbr title="Wins">W</abbr></th><th><abbr title="Draws">D</abbr></th>
          <th><abbr title="Losses">L</abbr></th><th><abbr title="Goals For">GF</abbr></th>
          <th><abbr title="Goals Against">GA</abbr></th><th><abbr title="Goal Difference">GD</abbr></th>
          <th><abbr title="Points">Pts</abbr></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p class="legend" id="legend"><strong>Legend:</strong></p>
</div>

<script>
/* === Source JSON ===
   By default uses your GitHub RAW. You can override via ?json=<url>
*/
const DEFAULT_JSON_URL = "https://cdn.jsdelivr.net/gh/rckd-nl/website@main/league-tables.json";

/* ---- DOM ---- */
const els = {
  seasonSel: document.getElementById('season-select'),
  pills: document.getElementById('division-pills'),
  tbody: document.querySelector('#standings tbody'),
  caption: document.getElementById('table-caption'),
  legend: document.getElementById('legend'),
  err: document.getElementById('error')
};
const state = { seasons:[], byKey:{}, current:{ season:null, division:null } };

/* ---- Utils ---- */
const showErr = (m,d) => { els.err.style.display='block'; els.err.textContent=d?(m+"\n\n"+d):m; console.error(m,d||''); };
const clearErr = () => { els.err.style.display='none'; els.err.textContent=''; };
const startYear = s => { const m=/^(\d{4})/.exec(String(s)||''); return m?+m[1]:0; };
const ORDER = { National:0, Alliance:0, Conference:0, Premier:0, North:1, South:2 };
const classForGD = n => n>0?'gd-pos':(n<0?'gd-neg':'gd-zero');
const num = x => Number(String(x??'').replace(/[^\d.-]/g,'')||NaN);

/* Allow ?json= override + ?season= default */
function getJSONURL(){
  try{
    const u = new URL(location.href);
    const j = u.searchParams.get('json');
    return j || DEFAULT_JSON_URL;
  }catch{ return DEFAULT_JSON_URL; }
}

/* Normaliser supports:
   - { seasons:[ { season, divisions } ] }
   - [ { season, divisions } ]
   - { "YYYY-YY": { rows } }  (assumed "National")
   - { "YYYY-YY": { groups:[ {name/title, rows} ] } }
*/
function normalize(raw){
  if (!raw) return [];
  if (Array.isArray(raw)) return raw.filter(s=>s?.season && s?.divisions);
  if (Array.isArray(raw.seasons)) return raw.seasons.filter(s=>s?.season && s?.divisions);

  const out=[];
  Object.keys(raw||{}).forEach(k=>{
    const v=raw[k]; if (!v || typeof v!=='object') return;

    if (v.divisions){ out.push({ season:k, divisions:v.divisions }); return; }

    if (Array.isArray(v.groups)){
      const divisions={};
      v.groups.forEach(g=>{
        const name=g?.name || g?.title || 'Division';
        divisions[name] = { title:g?.title || (name+' '+k), rows:g?.rows||[] };
      });
      out.push({ season:k, divisions });
      return;
    }

    if (Array.isArray(v.rows)){
      out.push({ season:k, divisions:{ National:{ title:v.title||('National '+k), rows:v.rows } } });
    }
  });
  return out;
}

function buildIndex(items){
  const seasons = items.slice().sort((a,b)=> startYear(a.season)-startYear(b.season));
  state.seasons = seasons;
  state.byKey = Object.fromEntries(seasons.map(s=>[s.season,s]));
}

function populateSeasons(){
  const sel=els.seasonSel; sel.innerHTML='';
  if (!state.seasons.length){
    const o=document.createElement('option'); o.textContent='— no seasons —'; o.disabled=true; o.selected=true; sel.appendChild(o); return;
  }
  state.seasons.forEach(s=>{ const o=document.createElement('option'); o.value=s.season; o.textContent=s.season; sel.appendChild(o); });
}

function renderPills(seasonKey, divisions){
  const names=Object.keys(divisions||{});
  els.pills.innerHTML='';
  if (names.length<=1){ els.pills.style.display='none'; els.pills.removeAttribute('data-era'); return; }
  els.pills.style.display='flex';
  els.pills.setAttribute('data-era', startYear(seasonKey) >= 2004 ? 'modern':'pre');

  names.slice().sort((a,b)=>(ORDER[a]??3)-(ORDER[b]??3)||a.localeCompare(b)).forEach(n=>{
    const b=document.createElement('button'); b.type='button'; b.textContent=n;
    b.setAttribute('aria-pressed', n===state.current.division?'true':'false');
    b.addEventListener('click',()=> renderTable(state.current.season,n));
    els.pills.appendChild(b);
  });
}

/* Bold only Pos, Pts (+ PPG if present) */
function markStrongColumns(){
  const thead = document.querySelector('#standings thead tr');
  const headers = Array.from(thead.cells).map(th => th.textContent.trim().toLowerCase());
  const strongIdx = ['pos','pts','ppg'].map(n=>headers.indexOf(n)).filter(i=>i>-1);

  // reset
  Array.from(thead.cells).forEach(th=> th.classList.remove('strongcol'));
  Array.from(els.tbody.rows).forEach(tr=> Array.from(tr.cells).forEach(td=> td.classList.remove('strongcol')));

  strongIdx.forEach(i=>{
    if (thead.cells[i]) thead.cells[i].classList.add('strongcol');
    Array.from(els.tbody.rows).forEach(tr=>{ if (tr.cells[i]) tr.cells[i].classList.add('strongcol'); });
  });
}

/* Add/remove PPG for 2019–20 only (compute from Pts / P) */
function handlePPG(seasonKey){
  const thead = document.querySelector('#standings thead tr');
  const wantPPG = /2019(?:-|–|—|\/)?20/i.test(seasonKey);

  const headerNames = Array.from(thead.cells).map(th => th.textContent.trim().toLowerCase());
  let idxPPG = headerNames.indexOf('ppg');
  const idxP   = headerNames.indexOf('p');
  const idxPts = headerNames.indexOf('pts');

  if (wantPPG){
    if (idxPPG === -1){
      const th = document.createElement('th'); th.innerHTML = '<abbr title="Points per game">PPG</abbr>';
      thead.appendChild(th);
      idxPPG = thead.cells.length - 1;
    }
    Array.from(els.tbody.rows).forEach(tr=>{
      let cell = tr.cells[idxPPG];
      if (!cell){ cell = document.createElement('td'); tr.appendChild(cell); }
      cell.classList.add('ppg');
      const P   = num(tr.cells[idxP]?.textContent);
      const Pts = num(tr.cells[idxPts]?.textContent);
      const val = (P>0 && isFinite(Pts/P)) ? (Pts/P).toFixed(2) : '';
      cell.textContent = val;
    });
  } else if (idxPPG !== -1){
    // remove the PPG column if present
    thead.deleteCell(idxPPG);
    Array.from(els.tbody.rows).forEach(tr=>{ if (tr.cells[idxPPG]) tr.deleteCell(idxPPG); });
  }
}

/* Legend per visible table (single Expunged entry) */
function rebuildLegend(){
  const rows = Array.from(els.tbody.rows);
  const has = {
    champion : rows.some(r=> r.classList.contains('champion')),
    promoted : rows.some(r=> r.classList.contains('promoted')),
    playoff  : rows.some(r=> r.classList.contains('playoff')),
    relegated: rows.some(r=> r.classList.contains('relegated')),
    expunged : rows.some(r=> r.classList.contains('expunged')),
  };
  const parts=[];
  if (has.champion)  parts.push('<span class="swatch gold"></span>Champions');
  if (has.promoted)  parts.push('<span class="swatch green"></span>Promoted');
  if (has.playoff)   parts.push('<span class="swatch blue"></span>Play-off');
  if (has.relegated) parts.push('<span class="swatch pink"></span>Relegated');
  if (has.expunged)  parts.push('<span class="swatch grey"></span>Expunged');
  els.legend.innerHTML = '<strong>Legend:</strong> ' + (parts.join(', ') || '—');
}

/* Render one table */
function renderTable(seasonKey, preferredDivision){
  const season = state.byKey[seasonKey]; if (!season) return;

  const names = Object.keys(season.divisions||{});
  const pickFirst=()=> names.includes('National') ? 'National' : names.includes('North') ? 'North' : names.includes('South') ? 'South' : names[0];
  const chosen = preferredDivision || state.current.division || pickFirst();
  const div = season.divisions[chosen] || season.divisions[pickFirst()];

  state.current.season=seasonKey; state.current.division=chosen;

  renderPills(seasonKey, season.divisions);
  [...els.pills.querySelectorAll('button')].forEach(b=> b.setAttribute('aria-pressed', b.textContent===chosen?'true':'false'));

  els.caption.textContent = (div && div.title) || season.title || (`${seasonKey} — ${chosen}`);

  els.tbody.innerHTML='';
  const rows=(div&&div.rows||[]).slice().sort((a,b)=>{
    const pa = (a.pos||0), pb = (b.pos||0);
    if (pa===0 && pb!==0) return 1; if (pb===0 && pa!==0) return -1;
    return pa - pb;
  });

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    (r.classes||[]).forEach(c=> tr.classList.add(c));

    const gdFromJSON = Number(String(r.GD ?? '').replace(/\s/g,''));
    const gdCalc = (num(r.GF) - num(r.GA));
    const gd = isFinite(gdFromJSON) ? gdFromJSON : (isFinite(gdCalc) ? gdCalc : NaN);

    const cells=[r.pos,r.team,r.P,r.W,r.D,r.L,r.GF,r.GA,{gd},r.Pts];
    cells.forEach((val,i)=>{
      const td=document.createElement('td');
      if (i===8){
        const n = Number((val && val.gd) != null ? val.gd : val);
        if (isFinite(n)){ td.textContent = (n>0?('+'+n):String(n)); td.classList.add(classForGD(n)); }
        else { td.textContent=''; td.classList.add('gd-zero'); }
      } else {
        td.textContent = (val!=null ? val : '');
      }
      tr.appendChild(td);
    });
    els.tbody.appendChild(tr);
  });

  handlePPG(seasonKey);
  markStrongColumns();
  rebuildLegend();

  // Tell parent our height so it can remove iframe scroll
  try{
    const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
    parent.postMessage({ type:'NL_TABLES_HEIGHT', height:h }, '*');
  }catch{}
}

/* Boot */
(async function boot(){
  clearErr();
  const loading=document.createElement('option');
  loading.textContent='Loading…'; loading.disabled=true; loading.selected=true;
  els.seasonSel.appendChild(loading);

  // Support ?season=<YYYY-YY> default
  let wantedSeason=null;
  try{ const u=new URL(location.href); wantedSeason = u.searchParams.get('season'); }catch{}

  try{
    const src = getJSONURL();
    const res=await fetch(src + (src.includes('?')?'&':'?') + 'v=' + Date.now(), { cache:'no-store', credentials:'omit' });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const text=await res.text();

    let raw=null;
    try{ raw=JSON.parse(text); }
    catch(parseErr){
      const s=text.indexOf('{'), e=text.lastIndexOf('}');
      if (s>=0 && e>s){ try{ raw=JSON.parse(text.slice(s,e+1)); } catch(e2){ return showErr('Fetched file was not valid JSON', parseErr.message); } }
      else return showErr('Fetched file was not JSON (likely an HTML page).','Use a RAW or CDN URL.');
    }

    const items=normalize(raw);
    if (!items.length){
      const keys = raw && typeof raw==='object' ? Object.keys(raw).slice(0,8).join(', ') : 'none';
      return showErr('No seasons found after normalizing the JSON.','Top-level keys: '+keys);
    }

    buildIndex(items);
    populateSeasons();

    // Always default to earliest season (1979–80) unless ?season= provided
    const initial = (wantedSeason && state.byKey[wantedSeason]) ? wantedSeason : state.seasons[0].season;
    els.seasonSel.value = initial;
    renderTable(initial,null);
    els.seasonSel.addEventListener('change',()=>renderTable(els.seasonSel.value,null));
  }catch(err){
    showErr('Network/CORS error while fetching JSON', err.message);
  }
})();

addEventListener('resize', ()=>{
  try{
    const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
    parent.postMessage({ type:'NL_TABLES_HEIGHT', height:h }, '*');
  }catch{}
});
</script>
</body>
</html>
